name: Legacy UI Import Guard

on:
  pull_request:
    paths:
      - 'apps/dashboard/src/**'
  push:
    branches:
      - main
      - develop
    paths:
      - 'apps/dashboard/src/**'

jobs:
  check-legacy-imports:
    name: Prevent Legacy UI Imports
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check for forbidden legacy imports
        run: |
          echo "Checking for imports from quarantined legacy UI..."

          # Check for any imports from dashboard-legacy
          if grep -R "from ['\"].*dashboard-legacy" apps/dashboard/src \
            --include=\*.ts --include=\*.tsx \
            --exclude-dir=node_modules; then
            echo ""
            echo "❌ FORBIDDEN: Import from dashboard-legacy detected!"
            echo ""
            echo "Legacy UI (Pages Router, admin components) is quarantined."
            echo "The dashboard uses App Router only."
            echo ""
            echo "Solution: Refactor the code or move to dashboard-legacy"
            exit 1
          fi

          # Check for old pages/ imports
          if grep -R "from ['\"]@/pages/" apps/dashboard/src \
            --include=\*.ts --include=\*.tsx \
            --exclude-dir=node_modules; then
            echo ""
            echo "❌ FORBIDDEN: Import from src/pages/ detected!"
            echo ""
            echo "Pages Router code has been moved to apps/dashboard-legacy/pages"
            echo ""
            echo "Solution: Migrate to App Router or move to legacy"
            exit 1
          fi

          # Check for admin component imports
          if grep -R "from ['\"]@/components/admin" apps/dashboard/src \
            --include=\*.ts --include=\*.tsx \
            --exclude-dir=node_modules; then
            echo ""
            echo "❌ FORBIDDEN: Admin component import detected!"
            echo ""
            echo "Admin components moved to apps/dashboard-legacy/admin"
            echo ""
            echo "Solution: Remove the import or migrate component to App Router"
            exit 1
          fi

          echo "✅ No forbidden legacy imports detected"

      - name: Summary
        if: success()
        run: |
          echo "## ✅ Legacy UI Import Guard Passed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "No imports from quarantined legacy UI detected." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Quarantined paths:**" >> $GITHUB_STEP_SUMMARY
          echo "- \`apps/dashboard-legacy/pages/**\` (Pages Router)" >> $GITHUB_STEP_SUMMARY
          echo "- \`apps/dashboard-legacy/admin/**\` (Admin components)" >> $GITHUB_STEP_SUMMARY
          echo "- \`apps/dashboard-legacy/app-admin/**\` (Admin app routes)" >> $GITHUB_STEP_SUMMARY
