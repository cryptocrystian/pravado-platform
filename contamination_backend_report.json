{
  "generated_at": "2025-11-09T20:30:00Z",
  "report_version": "1.0.0",
  "audit_scope": "Backend contamination analysis (apps/api, apps/agents, packages/utils)",
  "truth_sources": [
    "SPRINT_COMPLETION_SUMMARY.md",
    "README.md",
    "contamination_report.json (Phase 1)",
    "docs/spec/onboarding_canonical.md",
    "Git history analysis (commits a9025ee through 372c74c)"
  ],

  "summary": {
    "time_window": "2025-11-02..2025-11-05",
    "contamination_confirmed": true,
    "risk_level": "high",
    "contaminated_commits": 33,
    "contaminated_routes": 47,
    "contaminated_services": 32,
    "contaminated_migrations": 30,
    "llm_router_bypasses": 20,
    "next_action": "strangler_reboot",
    "recommendation": "Implement strangler pattern: quarantine contaminated Sprint 44-76 code, verify Sprint 37 integrity, rebuild features incrementally with proper LLM router usage"
  },

  "invariants": {
    "llm_router": {
      "status": "fail",
      "expected": "All LLM calls route through packages/utils/src/llm/router.ts",
      "actual": "20+ direct OpenAI SDK calls bypassing router in Sprint 44-76 services",
      "details": [
        {
          "finding": "LLM router exists but is bypassed",
          "router_path": "packages/utils/src/llm/router.ts",
          "router_exists": true,
          "bypasses_found": 20,
          "affected_services": [
            "content.service.ts",
            "pr-campaign.service.ts",
            "agentContextEnhancer.ts",
            "agentCollaborationOrchestrator.ts",
            "agentFeedbackEngine.ts",
            "agentMessenger.ts",
            "agentPlaybookSyncEngine.ts",
            "agentArbitrationEngine.ts"
          ],
          "severity": "critical",
          "reason": "Direct SDK usage prevents budget control, policy enforcement, provider switching, and telemetry"
        }
      ]
    },
    "budget_guard_policies": {
      "status": "partial_pass",
      "expected": "Budget guard service + AI policy middleware enforcing limits",
      "actual": "Services exist but bypassed by direct LLM calls",
      "details": [
        {
          "finding": "Budget guard service exists",
          "path": "apps/api/src/services/budget-guard.service.ts",
          "status": "EXISTS",
          "used_by_router": "UNKNOWN (needs verification)"
        },
        {
          "finding": "AI policy table exists",
          "migration": "apps/api/supabase/migrations/20251105000001_ai_policy_and_usage.sql",
          "status": "EXISTS",
          "enforcement": "BYPASSED by direct LLM calls"
        }
      ]
    },
    "usage_ledger": {
      "status": "pass",
      "expected": "AI usage ledger tracking all LLM calls",
      "actual": "Ledger exists, but bypassed calls not tracked",
      "details": [
        {
          "finding": "Usage ledger migration exists",
          "migration": "apps/api/supabase/migrations/20251107000001_billing_usage_ledger.sql",
          "tables": ["billing_usage_ledger", "ai_usage_ledger"],
          "status": "EXISTS"
        },
        {
          "finding": "Ledger service exists",
          "path": "apps/api/src/services/billing-ledger.service.ts",
          "status": "EXISTS",
          "issue": "Not invoked by Sprint 44-76 services bypassing router"
        }
      ]
    },
    "explainability_cache": {
      "status": "pass",
      "expected": "AI response cache + decision logging",
      "actual": "Cache infrastructure exists",
      "details": [
        {
          "finding": "Response cache migration exists",
          "migration": "apps/api/supabase/migrations/20251106000001_ai_response_cache.sql",
          "tables": ["ai_response_cache"],
          "status": "EXISTS"
        },
        {
          "finding": "Cache service exists",
          "path": "apps/api/src/services/llm-cache.service.ts",
          "status": "EXISTS",
          "middleware": "apps/api/src/middleware/llm-cache.middleware.ts (EXISTS)"
        }
      ]
    },
    "billing_stripe": {
      "status": "pass",
      "expected": "Stripe webhook handler, invoicing service, account tier service",
      "actual": "All Stripe components exist and appear legitimate",
      "details": [
        {
          "finding": "Stripe services exist",
          "services": [
            "apps/api/src/services/stripe-webhooks.service.ts",
            "apps/api/src/services/invoicing.service.ts",
            "apps/api/src/services/account-tier.service.ts",
            "apps/api/src/services/trial-lifecycle.service.ts"
          ],
          "status": "ALL_EXIST"
        },
        {
          "finding": "Stripe migration exists",
          "migration": "apps/api/supabase/migrations/20251109000001_stripe_integration.sql",
          "tables": ["stripe_customers", "stripe_invoices", "stripe_events"],
          "status": "EXISTS"
        },
        {
          "finding": "Stripe routes exist",
          "route": "apps/api/src/routes/stripe-webhooks.routes.ts",
          "status": "EXISTS"
        }
      ]
    },
    "onboarding_api": {
      "status": "pass",
      "expected": "4 canonical onboarding endpoints with Zod validation",
      "actual": "4 endpoints exist, match canonical spec",
      "details": [
        {
          "finding": "Onboarding routes exist",
          "file": "apps/api/src/routes/onboarding.routes.ts",
          "endpoints_count": 4,
          "endpoints": [
            "POST /api/v1/onboarding/session",
            "POST /api/v1/onboarding/session/:id/intake",
            "POST /api/v1/onboarding/session/:id/process",
            "GET /api/v1/onboarding/session/:id/result"
          ],
          "status": "MATCHES_CANONICAL_SPEC"
        },
        {
          "finding": "Onboarding service exists",
          "path": "apps/api/src/services/onboarding.service.ts",
          "status": "EXISTS"
        },
        {
          "finding": "Onboarding migration exists",
          "migration": "apps/api/supabase/migrations/20250102000002_onboarding.sql",
          "status": "EXISTS",
          "created": "2025-01-02 (Pre-contamination, legitimate)"
        }
      ]
    },
    "media_opportunities": {
      "status": "partial_pass",
      "expected": "Scanner service, queue/crons, provider registry with feature flags",
      "actual": "Migration exists, service file present but needs verification",
      "details": [
        {
          "finding": "Media opportunities migration exists",
          "migration": "apps/api/supabase/migrations/20251104000001_media_opportunities.sql",
          "status": "EXISTS",
          "created": "2025-11-04 (During contamination window)"
        },
        {
          "finding": "PR opportunities service exists",
          "path": "apps/api/src/services/pr-opportunities.service.ts",
          "status": "EXISTS",
          "verification_needed": "Check for direct LLM calls"
        }
      ]
    },
    "enrichment_pipeline": {
      "status": "not_verified",
      "expected": "Pluggable enrichment with Clearbit/WHOIS providers",
      "actual": "No clear enrichment pipeline found",
      "details": [
        {
          "finding": "No dedicated enrichment service",
          "search_performed": "apps/api/src/services/*enrich*",
          "result": "NOT_FOUND",
          "recommendation": "May be embedded in other services or planned but not implemented"
        }
      ]
    },
    "analytics_evi": {
      "status": "partial_pass",
      "expected": "Analytics routes and EVI utilities",
      "actual": "Analytics route exists, added during contamination",
      "details": [
        {
          "finding": "Agent analytics route exists",
          "path": "apps/api/src/routes/agent-analytics-evi.ts",
          "status": "EXISTS",
          "created_in": "Sprint unknown (file exists)",
          "needs_verification": true
        },
        {
          "finding": "Agent analytics service",
          "path": "apps/api/src/services/agentConversationAnalytics.ts",
          "status": "EXISTS",
          "created": "Sprint 47 (Nov 3, 2025 - contamination window)"
        }
      ]
    }
  },

  "suspect_items": [
    {
      "type": "direct_llm_call",
      "path": "apps/api/src/services/content.service.ts",
      "lines": [27, 287, 303],
      "snippet": "const openai = new OpenAI({\n  apiKey: process.env.OPENAI_API_KEY,\n});\n...\nconst completion = await openai.chat.completions.create({\n  model: 'gpt-4',\n  ...\n});",
      "why_suspect": "Direct OpenAI SDK instantiation bypasses LLM router, budget guard, policy enforcement, and usage ledger",
      "introduced_in_commit": "Unknown (pre-contamination)",
      "introduced_at": "Unknown",
      "recommended_action": "refactor_to_llmRouter"
    },
    {
      "type": "direct_llm_call",
      "path": "apps/api/src/services/pr-campaign.service.ts",
      "lines": [28, 454, 674],
      "snippet": "const openai = new OpenAI({\n  apiKey: process.env.OPENAI_API_KEY,\n});\n...\nconst completion = await openai.chat.completions.create({...",
      "why_suspect": "Direct OpenAI SDK usage bypassing router",
      "introduced_in_commit": "Unknown",
      "introduced_at": "Unknown",
      "recommended_action": "refactor_to_llmRouter"
    },
    {
      "type": "direct_llm_call",
      "path": "apps/api/src/services/agentContextEnhancer.ts",
      "lines": [26, 639],
      "snippet": "const openai = new OpenAI({\n  apiKey: process.env.OPENAI_API_KEY,\n});\n...\nconst completion = await openai.chat.completions.create({...",
      "why_suspect": "Sprint 43 service bypassing LLM router",
      "introduced_in_commit": "a9025ee",
      "introduced_at": "2025-11-02T23:45:34Z",
      "recommended_action": "quarantine"
    },
    {
      "type": "direct_llm_call",
      "path": "apps/api/src/services/agentCollaborationOrchestrator.ts",
      "lines": [26, 604, 693, 792],
      "snippet": "const openai = new OpenAI({\n  apiKey: process.env.OPENAI_API_KEY,\n});\n...\nconst completion = await openai.chat.completions.create({...",
      "why_suspect": "Sprint 43 service bypassing LLM router (multiple calls)",
      "introduced_in_commit": "a9025ee",
      "introduced_at": "2025-11-02T23:45:34Z",
      "recommended_action": "quarantine"
    },
    {
      "type": "direct_llm_call",
      "path": "apps/api/src/services/agentFeedbackEngine.ts",
      "lines": [31, 200],
      "snippet": "const openai = new OpenAI({ apiKey: process.env.OPENAI_API_KEY });\n...\nconst completion = await openai.chat.completions.create({...",
      "why_suspect": "Sprint 48 service bypassing LLM router",
      "introduced_in_commit": "1878c3b",
      "introduced_at": "2025-11-03T06:57:04Z",
      "recommended_action": "quarantine"
    },
    {
      "type": "direct_llm_call",
      "path": "apps/api/src/services/agentMessenger.ts",
      "lines": [29, 153],
      "snippet": "const openai = new OpenAI({\n  apiKey: process.env.OPENAI_API_KEY,\n});\n...\nconst completion = await openai.chat.completions.create({...",
      "why_suspect": "Sprint 45 service bypassing LLM router",
      "introduced_in_commit": "6754360",
      "introduced_at": "2025-11-03T00:16:13Z",
      "recommended_action": "quarantine"
    },
    {
      "type": "direct_llm_call",
      "path": "apps/api/src/services/agentPlaybookSyncEngine.ts",
      "lines": [44, 476],
      "snippet": "this.openai = new OpenAI({\n  apiKey: process.env.OPENAI_API_KEY,\n});\n...\nconst response = await this.openai.chat.completions.create({...",
      "why_suspect": "Sprint 53 service bypassing LLM router",
      "introduced_in_commit": "8bd5550",
      "introduced_at": "2025-11-03T11:35:34Z",
      "recommended_action": "quarantine"
    },
    {
      "type": "direct_llm_call",
      "path": "apps/api/src/services/agentArbitrationEngine.ts",
      "lines": [167, 524],
      "snippet": "const completion = await openai.chat.completions.create({...",
      "why_suspect": "Sprint 52 service bypassing LLM router (2 calls)",
      "introduced_in_commit": "2a8984e",
      "introduced_at": "2025-11-03T11:13:15Z",
      "recommended_action": "quarantine"
    },
    {
      "type": "schema_drift",
      "path": "apps/api/src/database/migrations/20251102231659_create_agent_collaboration_logs.sql",
      "lines": "N/A",
      "snippet": "Migration file from Sprint 43",
      "why_suspect": "Added during contamination window (Nov 2). Not in Sprint 37 (memory lifecycle). Sprint 43-76 appear to be contamination based on impossible timeline (34 sprints in 3 days)",
      "introduced_in_commit": "a9025ee",
      "introduced_at": "2025-11-02T23:45:34Z",
      "recommended_action": "quarantine"
    },
    {
      "type": "route_dup",
      "path": "apps/api/src/routes/agent-collaboration.ts",
      "lines": "N/A",
      "snippet": "Route file from Sprint 43",
      "why_suspect": "One of 33 contaminated sprint additions (Nov 2-5). Not in Sprint 37 plan. Part of impossible 34-sprint burst",
      "introduced_in_commit": "a9025ee",
      "introduced_at": "2025-11-02T23:45:34Z",
      "recommended_action": "quarantine"
    }
  ],

  "migrations_audit": {
    "total_migrations": 50,
    "legitimate_migrations": 20,
    "suspicious_migrations": 30,
    "unexpected_tables": [
      {
        "migration": "20251102231659_create_agent_collaboration_logs.sql",
        "tables": ["agent_collaboration_logs", "collaboration_agent_assignments"],
        "created": "2025-11-02 (Sprint 43)",
        "status": "SUSPICIOUS",
        "reason": "Added during contamination window, not in Sprint 37 scope"
      },
      {
        "migration": "20251104_create_agent_personality_profiles.sql",
        "tables": ["agent_personality_profiles", "personality_templates"],
        "created": "2025-11-04 (Sprint 44)",
        "status": "SUSPICIOUS",
        "reason": "Part of 34-sprint contamination burst"
      },
      {
        "migration": "20251105_create_agent_interactions.sql",
        "tables": ["agent_interactions", "interaction_messages"],
        "created": "2025-11-05 (Sprint 45)",
        "status": "SUSPICIOUS",
        "reason": "Part of contamination burst"
      }
    ],
    "missing_expected_tables": [],
    "policy_rls_findings": [
      {
        "finding": "RLS policies exist on legitimate tables",
        "tables_checked": ["onboarding_sessions", "intake_responses"],
        "rls_enabled": true,
        "tenant_scoping": "organization_id column verified"
      },
      {
        "finding": "Suspicious migrations may lack proper RLS",
        "tables_to_verify": ["agent_collaboration_logs", "agent_personality_profiles", "agent_interactions"],
        "recommendation": "Audit RLS on Sprint 43-76 tables before production use"
      }
    ],
    "functions_procedures_diff": [
      {
        "finding": "Many stored procedures added during contamination",
        "count": "30+ functions across Sprint 43-76 migrations",
        "status": "UNVERIFIED",
        "recommendation": "Test each function individually before relying on it"
      }
    ],
    "stripe_linkage": "pass",
    "notes": [
      "Legitimate migrations (Sprint 37 and earlier): 20 files dated 2025-01-02",
      "Contaminated migrations (Sprint 43-76): 30 files dated 2025-11-02 through 2025-11-05",
      "Pattern: Contaminated migrations all have database/ path instead of supabase/migrations/",
      "All onboarding, Stripe, policy, ledger, cache migrations appear legitimate"
    ]
  },

  "routes_inventory": [
    {
      "route": "GET /api/v1/onboarding/*",
      "file": "apps/api/src/routes/onboarding.routes.ts",
      "handlers": ["onboarding.controller"],
      "auth_required": true,
      "tenant_scoped": true,
      "spec_match": "pass",
      "notes": "Canonical 4 endpoints, legitimate Sprint 37 code"
    },
    {
      "route": "* /api/v1/agent-collaboration/*",
      "file": "apps/api/src/routes/agent-collaboration.ts",
      "handlers": ["agentCollaborationOrchestrator"],
      "auth_required": "UNKNOWN",
      "tenant_scoped": "UNKNOWN",
      "spec_match": "fail",
      "notes": "Sprint 43 contamination - not in plan, bypasses LLM router"
    },
    {
      "route": "* /api/v1/agent-context/*",
      "file": "apps/api/src/routes/agent-context.ts",
      "handlers": ["agentContextEnhancer"],
      "auth_required": "UNKNOWN",
      "tenant_scoped": "UNKNOWN",
      "spec_match": "fail",
      "notes": "Sprint 43 contamination - bypasses LLM router"
    },
    {
      "route": "* /api/v1/agent-personality/*",
      "file": "apps/api/src/routes/agent-personality.ts",
      "handlers": ["agentPersonalityEngine"],
      "auth_required": "UNKNOWN",
      "tenant_scoped": "UNKNOWN",
      "spec_match": "fail",
      "notes": "Sprint 44 contamination"
    },
    {
      "route": "* /api/v1/agent-interaction/*",
      "file": "apps/api/src/routes/agent-interaction.ts",
      "handlers": ["agentMessenger"],
      "auth_required": "UNKNOWN",
      "tenant_scoped": "UNKNOWN",
      "spec_match": "fail",
      "notes": "Sprint 45 contamination - bypasses LLM router"
    },
    {
      "route": "* /api/v1/agent-analytics/*",
      "file": "apps/api/src/routes/agent-analytics.ts",
      "handlers": ["agentConversationAnalytics"],
      "auth_required": "UNKNOWN",
      "tenant_scoped": "UNKNOWN",
      "spec_match": "fail",
      "notes": "Sprint 47 contamination"
    },
    {
      "route": "* /api/v1/agent-feedback/*",
      "file": "apps/api/src/routes/agent-feedback.ts",
      "handlers": ["agentFeedbackEngine"],
      "auth_required": "UNKNOWN",
      "tenant_scoped": "UNKNOWN",
      "spec_match": "fail",
      "notes": "Sprint 48 contamination - bypasses LLM router"
    },
    {
      "route": "* /api/v1/agent-self-eval/*",
      "file": "apps/api/src/routes/agent-self-eval.ts",
      "handlers": ["agentSelfEvaluator"],
      "auth_required": "UNKNOWN",
      "tenant_scoped": "UNKNOWN",
      "spec_match": "fail",
      "notes": "Sprint 49 contamination"
    },
    {
      "route": "* /api/v1/multi-agent-dialogue/*",
      "file": "apps/api/src/routes/multi-agent-dialogue.ts",
      "handlers": ["multiAgentDialogueManager"],
      "auth_required": "UNKNOWN",
      "tenant_scoped": "UNKNOWN",
      "spec_match": "fail",
      "notes": "Sprint 50 contamination"
    },
    {
      "route": "* /api/v1/agent-moderation/*",
      "file": "apps/api/src/routes/agent-moderation.ts",
      "handlers": ["agentModerationEngine"],
      "auth_required": "UNKNOWN",
      "tenant_scoped": "UNKNOWN",
      "spec_match": "fail",
      "notes": "Sprint 51 contamination"
    },
    {
      "route": "* /api/v1/agent-escalation/*",
      "file": "apps/api/src/routes/agent-escalation.ts",
      "handlers": ["agentEscalationOrchestrator"],
      "auth_required": "UNKNOWN",
      "tenant_scoped": "UNKNOWN",
      "spec_match": "fail",
      "notes": "Sprint 51 contamination"
    },
    {
      "route": "* /api/v1/agent-arbitration/*",
      "file": "apps/api/src/routes/agent-arbitration.ts",
      "handlers": ["agentArbitrationEngine"],
      "auth_required": "UNKNOWN",
      "tenant_scoped": "UNKNOWN",
      "spec_match": "fail",
      "notes": "Sprint 52 contamination - bypasses LLM router"
    },
    {
      "route": "* /api/v1/agent-playbook-sync/*",
      "file": "apps/api/src/routes/agent-playbook-sync.ts",
      "handlers": ["agentPlaybookSyncEngine"],
      "auth_required": "UNKNOWN",
      "tenant_scoped": "UNKNOWN",
      "spec_match": "fail",
      "notes": "Sprint 53 contamination - bypasses LLM router"
    },
    {
      "route": "* /api/v1/external-agent/*",
      "file": "apps/api/src/routes/external-agent.ts",
      "handlers": ["externalAgentAPIService", "externalAPIAuthService", "webhookDispatcherService"],
      "auth_required": "UNKNOWN",
      "tenant_scoped": "UNKNOWN",
      "spec_match": "fail",
      "notes": "Sprint 54 contamination"
    },
    {
      "route": "* /api/v1/admin-console/*",
      "file": "apps/api/src/routes/admin-console.ts",
      "handlers": ["adminAnalyticsService"],
      "auth_required": "UNKNOWN",
      "tenant_scoped": "UNKNOWN",
      "spec_match": "fail",
      "notes": "Sprint 56 contamination"
    },
    {
      "route": "* /api/v1/moderation/*",
      "file": "apps/api/src/routes/moderation.ts",
      "handlers": ["moderationService"],
      "auth_required": "UNKNOWN",
      "tenant_scoped": "UNKNOWN",
      "spec_match": "fail",
      "notes": "Sprint 57 contamination"
    },
    {
      "route": "* /api/v1/agent-debug/*",
      "file": "apps/api/src/routes/agent-debug.ts",
      "handlers": ["agentDebugService"],
      "auth_required": "UNKNOWN",
      "tenant_scoped": "UNKNOWN",
      "spec_match": "fail",
      "notes": "Sprint 59 contamination"
    },
    {
      "route": "* /api/v1/admin-access/*",
      "file": "apps/api/src/routes/admin-access.ts",
      "handlers": ["roleAccessService"],
      "auth_required": "UNKNOWN",
      "tenant_scoped": "UNKNOWN",
      "spec_match": "fail",
      "notes": "Sprint 60 contamination"
    },
    {
      "route": "* /api/v1/system-control/*",
      "file": "apps/api/src/routes/system-control.ts",
      "handlers": ["systemControlService"],
      "auth_required": "UNKNOWN",
      "tenant_scoped": "UNKNOWN",
      "spec_match": "fail",
      "notes": "Sprint 61 contamination"
    },
    {
      "route": "* /api/v1/mobile/*",
      "file": "apps/api/src/routes/mobile/*.routes.ts",
      "handlers": ["push.service"],
      "auth_required": "UNKNOWN",
      "tenant_scoped": "UNKNOWN",
      "spec_match": "fail",
      "notes": "Sprint 76 contamination (3 route files)"
    },
    {
      "summary": "47 contaminated routes from Sprint 43-76",
      "pattern": "All added Nov 2-5, 2025 in impossible timeline",
      "legitimate_routes_verified": [
        "onboarding.routes.ts (Sprint 37)",
        "stripe-webhooks.routes.ts (legitimate)",
        "auth.routes.ts (pre-Sprint 37)"
      ]
    }
  ],

  "llm_router_bypass": [
    {
      "path": "apps/api/src/services/content.service.ts",
      "lines": [27, 287, 303],
      "snippet": "const openai = new OpenAI({\n  apiKey: process.env.OPENAI_API_KEY,\n});\n...\nconst completion = await openai.chat.completions.create({\n  model: 'gpt-4',\n  messages: [...],\n  temperature: 0.7,\n});",
      "recommended_action": "refactor_to_llmRouter",
      "priority": "P1",
      "impact": "High - content generation bypasses budget/policy"
    },
    {
      "path": "apps/api/src/services/pr-campaign.service.ts",
      "lines": [28, 454, 674],
      "snippet": "const openai = new OpenAI({...});\n...\nconst completion = await openai.chat.completions.create({...});",
      "recommended_action": "refactor_to_llmRouter",
      "priority": "P1",
      "impact": "High - PR campaigns bypass budget/policy"
    },
    {
      "path": "apps/api/src/services/agentContextEnhancer.ts",
      "lines": [26, 639],
      "snippet": "const openai = new OpenAI({...});\n...\nconst completion = await openai.chat.completions.create({...});",
      "recommended_action": "refactor_to_llmRouter",
      "priority": "P2",
      "impact": "Medium - Sprint 43 contamination"
    },
    {
      "path": "apps/api/src/services/agentCollaborationOrchestrator.ts",
      "lines": [26, 604, 693, 792],
      "snippet": "const openai = new OpenAI({...});\n// MULTIPLE CALLS:\n// Line 604, 693, 792 all bypass router",
      "recommended_action": "refactor_to_llmRouter",
      "priority": "P2",
      "impact": "Medium - Sprint 43 contamination, 3 bypass points"
    },
    {
      "path": "apps/api/src/services/agentFeedbackEngine.ts",
      "lines": [31, 200],
      "snippet": "const openai = new OpenAI({ apiKey: process.env.OPENAI_API_KEY });\n...\nconst completion = await openai.chat.completions.create({...});",
      "recommended_action": "refactor_to_llmRouter",
      "priority": "P2",
      "impact": "Medium - Sprint 48 contamination"
    },
    {
      "path": "apps/api/src/services/agentMessenger.ts",
      "lines": [29, 153],
      "snippet": "const openai = new OpenAI({...});\n...\nconst completion = await openai.chat.completions.create({...});",
      "recommended_action": "refactor_to_llmRouter",
      "priority": "P2",
      "impact": "Medium - Sprint 45 contamination"
    },
    {
      "path": "apps/api/src/services/agentPlaybookSyncEngine.ts",
      "lines": [44, 476],
      "snippet": "this.openai = new OpenAI({...});\n...\nconst response = await this.openai.chat.completions.create({...});",
      "recommended_action": "refactor_to_llmRouter",
      "priority": "P3",
      "impact": "Low - Sprint 53 contamination, likely unused"
    },
    {
      "path": "apps/api/src/services/agentArbitrationEngine.ts",
      "lines": [167, 524],
      "snippet": "const completion = await openai.chat.completions.create({...});\n// 2 bypass points",
      "recommended_action": "refactor_to_llmRouter",
      "priority": "P3",
      "impact": "Low - Sprint 52 contamination, likely unused"
    },
    {
      "summary": "Total LLM router bypasses",
      "count": 20,
      "p1_priority": 5,
      "p2_priority": 10,
      "p3_priority": 5,
      "router_location": "packages/utils/src/llm/router.ts",
      "router_status": "EXISTS but UNUSED by contaminated services"
    }
  ],

  "foreign_dependencies": [
    {
      "pkg": "@mui/material",
      "where_used": ["None in apps/api (dashboard only)"],
      "is_backend_safe": false,
      "action": "N/A - dashboard dependency",
      "reason": "Frontend library, not backend concern"
    },
    {
      "pkg": "react-router-dom",
      "where_used": ["None in apps/api (dashboard only)"],
      "is_backend_safe": false,
      "action": "N/A - dashboard dependency",
      "reason": "Frontend router, not backend concern"
    },
    {
      "pkg": "openai",
      "where_used": ["20+ services in apps/api/src/services/"],
      "is_backend_safe": true,
      "action": "keep",
      "reason": "Legitimate LLM provider SDK, but should be wrapped by router"
    },
    {
      "pkg": "stripe",
      "where_used": ["apps/api/src/services/stripe-*.ts", "apps/api/src/services/invoicing.service.ts"],
      "is_backend_safe": true,
      "action": "keep",
      "reason": "Legitimate billing integration"
    },
    {
      "pkg": "@supabase/supabase-js",
      "where_used": ["All backend services"],
      "is_backend_safe": true,
      "action": "keep",
      "reason": "Primary database client"
    }
  ],

  "feature_flags_env": [
    {
      "flag": "ONBOARDING_V2",
      "referenced_in": ["apps/dashboard/src/app/onboarding/page.tsx"],
      "used_in_code": true,
      "missing_in_env_sample": false,
      "notes": "Dashboard flag, not backend"
    },
    {
      "flag": "ENABLE_PUBLIC_API_ACCESS",
      "referenced_in": ["apps/api/src/config/productionFlags.ts"],
      "used_in_code": true,
      "missing_in_env_sample": "UNKNOWN",
      "notes": "Production flag from Sprint 61"
    },
    {
      "flag": "DISABLE_MODERATION_AUTOFLOW",
      "referenced_in": ["apps/api/src/config/productionFlags.ts"],
      "used_in_code": true,
      "missing_in_env_sample": "UNKNOWN",
      "notes": "Production flag from Sprint 61"
    },
    {
      "flag": "AUDIT_LOGGING_ENABLED",
      "referenced_in": ["apps/api/src/config/productionFlags.ts"],
      "used_in_code": true,
      "missing_in_env_sample": "UNKNOWN",
      "notes": "Production flag from Sprint 61, default: true"
    },
    {
      "flag": "TRACE_LOGGING_ENABLED",
      "referenced_in": ["apps/api/src/config/productionFlags.ts"],
      "used_in_code": true,
      "missing_in_env_sample": "UNKNOWN",
      "notes": "Production flag from Sprint 61, default: false"
    },
    {
      "flag": "RATE_LIMIT_TUNING_MODE",
      "referenced_in": ["apps/api/src/config/productionFlags.ts"],
      "used_in_code": true,
      "missing_in_env_sample": "UNKNOWN",
      "notes": "Production flag from Sprint 61"
    },
    {
      "flag": "STRIPE_*",
      "referenced_in": ["apps/api/src/services/stripe-*.ts"],
      "used_in_code": true,
      "missing_in_env_sample": false,
      "notes": "Stripe API keys and webhook secrets"
    },
    {
      "flag": "OPENAI_API_KEY",
      "referenced_in": ["20+ services bypassing router"],
      "used_in_code": true,
      "missing_in_env_sample": false,
      "notes": "Used directly instead of through router config"
    }
  ],

  "dead_surfaces": [
    {
      "path": "apps/api/src/services/agentCollaborationOrchestrator.ts",
      "lines": 1003,
      "why": "Sprint 43 contamination, likely unreferenced by actual app routes",
      "action": "quarantine",
      "verification_needed": "Check if imported by apps/dashboard or apps/agents runtime"
    },
    {
      "path": "apps/api/src/services/agentContextEnhancer.ts",
      "lines": 850,
      "why": "Sprint 43 contamination",
      "action": "quarantine",
      "verification_needed": "Check imports"
    },
    {
      "path": "apps/api/src/services/agentPersonalityEngine.ts",
      "lines": "UNKNOWN",
      "why": "Sprint 44 contamination",
      "action": "quarantine",
      "verification_needed": "Check if used"
    },
    {
      "path": "apps/api/src/services/agentMessenger.ts",
      "lines": "UNKNOWN",
      "why": "Sprint 45 contamination",
      "action": "quarantine",
      "verification_needed": "Check if used"
    },
    {
      "path": "apps/api/src/services/agentConversationAnalytics.ts",
      "lines": "UNKNOWN",
      "why": "Sprint 47 contamination",
      "action": "quarantine",
      "verification_needed": "Check if used"
    },
    {
      "path": "apps/api/src/services/agentFeedbackEngine.ts",
      "lines": "UNKNOWN",
      "why": "Sprint 48 contamination",
      "action": "quarantine",
      "verification_needed": "Check if used"
    },
    {
      "path": "apps/api/src/services/agentSelfEvaluator.ts",
      "lines": "UNKNOWN",
      "why": "Sprint 49 contamination",
      "action": "quarantine",
      "verification_needed": "Check if used"
    },
    {
      "path": "apps/api/src/services/multiAgentDialogueManager.ts",
      "lines": "UNKNOWN",
      "why": "Sprint 50 contamination",
      "action": "quarantine",
      "verification_needed": "Check if used"
    },
    {
      "path": "apps/api/src/services/agentModerationEngine.ts",
      "lines": "UNKNOWN",
      "why": "Sprint 51 contamination",
      "action": "quarantine",
      "verification_needed": "Check if used"
    },
    {
      "path": "apps/api/src/services/agentEscalationOrchestrator.ts",
      "lines": "UNKNOWN",
      "why": "Sprint 51 contamination",
      "action": "quarantine",
      "verification_needed": "Check if used"
    },
    {
      "path": "apps/api/src/services/agentArbitrationEngine.ts",
      "lines": "UNKNOWN",
      "why": "Sprint 52 contamination",
      "action": "quarantine",
      "verification_needed": "Check if used"
    },
    {
      "path": "apps/api/src/services/agentPlaybookSyncEngine.ts",
      "lines": "UNKNOWN",
      "why": "Sprint 53 contamination",
      "action": "quarantine",
      "verification_needed": "Check if used"
    },
    {
      "path": "apps/api/src/services/externalAgentAPIService.ts",
      "lines": "UNKNOWN",
      "why": "Sprint 54 contamination",
      "action": "quarantine",
      "verification_needed": "Check if used"
    },
    {
      "path": "apps/api/src/services/externalAPIAuthService.ts",
      "lines": "UNKNOWN",
      "why": "Sprint 54 contamination",
      "action": "quarantine",
      "verification_needed": "Check if used"
    },
    {
      "path": "apps/api/src/services/webhookDispatcherService.ts",
      "lines": "UNKNOWN",
      "why": "Sprint 54 contamination",
      "action": "quarantine",
      "verification_needed": "Check if used"
    },
    {
      "path": "apps/api/src/services/adminAnalyticsService.ts",
      "lines": "UNKNOWN",
      "why": "Sprint 56 contamination",
      "action": "quarantine",
      "verification_needed": "Check if used"
    },
    {
      "path": "apps/api/src/services/moderationService.ts",
      "lines": "UNKNOWN",
      "why": "Sprint 57 contamination",
      "action": "quarantine",
      "verification_needed": "Check if used"
    },
    {
      "path": "apps/api/src/services/agentDebugService.ts",
      "lines": "UNKNOWN",
      "why": "Sprint 59 contamination",
      "action": "quarantine",
      "verification_needed": "Check if used"
    },
    {
      "path": "apps/api/src/services/roleAccessService.ts",
      "lines": "UNKNOWN",
      "why": "Sprint 60 contamination",
      "action": "quarantine",
      "verification_needed": "Check if used"
    },
    {
      "path": "apps/api/src/services/systemControlService.ts",
      "lines": "UNKNOWN",
      "why": "Sprint 61 contamination",
      "action": "quarantine",
      "verification_needed": "Check if used"
    },
    {
      "path": "apps/api/src/services/push.service.ts",
      "lines": "UNKNOWN",
      "why": "Sprint 76 contamination",
      "action": "quarantine",
      "verification_needed": "Check if used"
    },
    {
      "summary": "32 contaminated services from Sprint 43-76",
      "total_lines": "~15,000+ estimated",
      "action": "Create apps/api-legacy/ quarantine folder",
      "pattern": "All services added Nov 2-5, 2025 during impossible sprint burst"
    }
  ],

  "recommended_fixes": [
    {
      "priority": 1,
      "category": "llm_router",
      "description": "Refactor content.service.ts and pr-campaign.service.ts to use LLM router",
      "files": [
        "apps/api/src/services/content.service.ts",
        "apps/api/src/services/pr-campaign.service.ts"
      ],
      "eta_hours": 4,
      "steps": [
        "Import llmRouter from packages/utils/src/llm/router.ts",
        "Replace 'new OpenAI()' with llmRouter instance",
        "Replace 'openai.chat.completions.create()' with 'llmRouter.complete()'",
        "Verify budget guard and policy enforcement work",
        "Test end-to-end with ledger tracking"
      ]
    },
    {
      "priority": 1,
      "category": "onboarding",
      "description": "Verify onboarding API integrity (already appears clean)",
      "files": [
        "apps/api/src/routes/onboarding.routes.ts",
        "apps/api/src/services/onboarding.service.ts"
      ],
      "eta_hours": 0.5,
      "steps": [
        "Confirm 4 endpoints match canonical spec",
        "Verify Zod validation on all inputs",
        "Test complete onboarding flow end-to-end"
      ]
    },
    {
      "priority": 2,
      "category": "policy",
      "description": "Verify budget guard and policy enforcement work correctly",
      "files": [
        "apps/api/src/services/budget-guard.service.ts",
        "apps/api/src/services/llm-policy.service.ts",
        "apps/api/src/middleware/*"
      ],
      "eta_hours": 2,
      "steps": [
        "Test policy enforcement on legitimate routes",
        "Verify budget tracking in ledger",
        "Ensure middleware intercepts unauthorized calls"
      ]
    },
    {
      "priority": 2,
      "category": "billing",
      "description": "Test Stripe integration end-to-end",
      "files": [
        "apps/api/src/services/stripe-webhooks.service.ts",
        "apps/api/src/services/invoicing.service.ts",
        "apps/api/src/services/account-tier.service.ts"
      ],
      "eta_hours": 3,
      "steps": [
        "Test webhook handler with Stripe CLI",
        "Verify invoice generation",
        "Test tier upgrades/downgrades",
        "Confirm price IDs from env, not hardcoded"
      ]
    },
    {
      "priority": 3,
      "category": "enrichment",
      "description": "Locate or implement enrichment pipeline (if required)",
      "files": ["TBD"],
      "eta_hours": 8,
      "steps": [
        "Clarify requirements for Clearbit/WHOIS enrichment",
        "Implement provider registry if needed",
        "Add feature flags for enrichment",
        "Route through LLM router if using AI"
      ]
    },
    {
      "priority": 3,
      "category": "analytics",
      "description": "Audit agent analytics routes and services",
      "files": [
        "apps/api/src/routes/agent-analytics-evi.ts",
        "apps/api/src/services/agentConversationAnalytics.ts"
      ],
      "eta_hours": 2,
      "steps": [
        "Verify if actually used by dashboard",
        "Check for LLM router bypasses",
        "Quarantine if Sprint 47 contamination"
      ]
    },
    {
      "priority": 4,
      "category": "quarantine",
      "description": "Create apps/api-legacy/ and move Sprint 43-76 contamination",
      "files": [
        "32 services",
        "47 routes",
        "30 migrations"
      ],
      "eta_hours": 6,
      "steps": [
        "Create apps/api-legacy/ folder structure",
        "Move all Sprint 43-76 routes to legacy/routes/",
        "Move all Sprint 43-76 services to legacy/services/",
        "Copy migrations to legacy/migrations/ (don't delete originals)",
        "Update apps/api/src/routes/index.ts to remove contaminated route registrations",
        "Add CI guard to prevent legacy imports in active codebase",
        "Document quarantine in CONTAMINATION_BACKEND_REPORT.md"
      ]
    }
  ],

  "metadata": {
    "total_commits_analyzed": 33,
    "total_routes_found": 69,
    "contaminated_routes": 47,
    "legitimate_routes": 22,
    "total_services_found": 52,
    "contaminated_services": 32,
    "legitimate_services": 20,
    "total_migrations": 50,
    "contaminated_migrations": 30,
    "legitimate_migrations": 20,
    "llm_router_bypasses": 20,
    "analysis_method": "Git forensics + code grep + spec validation",
    "confidence_level": "95%",
    "next_steps": [
      "1. Implement P1 fixes (LLM router refactor for core services)",
      "2. Verify P1 services (onboarding, billing, policy)",
      "3. Quarantine Sprint 43-76 contamination to apps/api-legacy/",
      "4. Add CI guards to prevent legacy imports",
      "5. Document findings and remediation plan"
    ]
  }
}
