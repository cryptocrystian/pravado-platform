# =====================================================
# CLOUDFLARE PAGES CONFIGURATION
# Pravado Platform - Dashboard Deployment
# Version: 1.0.0
# =====================================================

name = "pravado-dashboard"
compatibility_date = "2024-01-01"
pages_build_output_dir = "apps/dashboard/dist"

# =====================================================
# BUILD CONFIGURATION
# =====================================================

[build]
command = "pnpm install --frozen-lockfile && pnpm build --filter=@pravado/dashboard"
cwd = "/"

[build.environment]
NODE_VERSION = "20.11.0"
PNPM_VERSION = "9.0.0"

# =====================================================
# ENVIRONMENT VARIABLES - PRODUCTION
# =====================================================

[env.production]
REACT_APP_ENV = "production"
REACT_APP_API_URL = "https://api.pravado.com"
REACT_APP_SUPABASE_URL = "https://your-project.supabase.co"
REACT_APP_SENTRY_DSN = "https://...@sentry.io/..."
REACT_APP_VERSION = "1.0.0"

# Feature Flags
REACT_APP_ENABLE_DEBUG = "false"
REACT_APP_ENABLE_ANALYTICS = "true"
REACT_APP_ENABLE_ERROR_TRACKING = "true"

# =====================================================
# ENVIRONMENT VARIABLES - PREVIEW
# =====================================================

[env.preview]
REACT_APP_ENV = "preview"
REACT_APP_API_URL = "https://api-preview.pravado.com"
REACT_APP_SUPABASE_URL = "https://your-project.supabase.co"
REACT_APP_SENTRY_DSN = "https://...@sentry.io/..."
REACT_APP_VERSION = "1.0.0-preview"

# Feature Flags
REACT_APP_ENABLE_DEBUG = "true"
REACT_APP_ENABLE_ANALYTICS = "true"
REACT_APP_ENABLE_ERROR_TRACKING = "true"

# =====================================================
# DEPLOYMENT CONFIGURATION
# =====================================================

[deployment]
# Compatibility flags for Workers
compatibility_flags = ["nodejs_compat"]

# =====================================================
# ROUTING RULES
# =====================================================

# SPA Fallback - All routes serve index.html
[[redirects]]
from = "/*"
to = "/index.html"
status = 200

# API Proxy (Optional - if using Cloudflare Workers for edge proxying)
[[redirects]]
from = "/api/*"
to = "https://api.pravado.com/:splat"
status = 200

# =====================================================
# HEADERS
# =====================================================

[[headers]]
for = "/*"
[headers.values]
X-Frame-Options = "DENY"
X-Content-Type-Options = "nosniff"
X-XSS-Protection = "1; mode=block"
Referrer-Policy = "strict-origin-when-cross-origin"
Permissions-Policy = "geolocation=(), microphone=(), camera=()"

# Security Headers
Content-Security-Policy = """
  default-src 'self';
  script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.jsdelivr.net;
  style-src 'self' 'unsafe-inline' https://fonts.googleapis.com;
  font-src 'self' https://fonts.gstatic.com;
  img-src 'self' data: https:;
  connect-src 'self' https://api.pravado.com https://*.supabase.co https://sentry.io;
  frame-ancestors 'none';
"""

[[headers]]
for = "/static/*"
[headers.values]
Cache-Control = "public, max-age=31536000, immutable"

[[headers]]
for = "/*.js"
[headers.values]
Cache-Control = "public, max-age=31536000, immutable"

[[headers]]
for = "/*.css"
[headers.values]
Cache-Control = "public, max-age=31536000, immutable"

[[headers]]
for = "/index.html"
[headers.values]
Cache-Control = "public, max-age=0, must-revalidate"

# =====================================================
# KV NAMESPACES (Optional)
# =====================================================

# Uncomment if using KV for caching or session storage
# [[kv_namespaces]]
# binding = "PRAVADO_CACHE"
# id = "your-kv-namespace-id"
# preview_id = "your-preview-kv-namespace-id"

# =====================================================
# DURABLE OBJECTS (Optional)
# =====================================================

# Uncomment if using Durable Objects for real-time features
# [[durable_objects.bindings]]
# name = "CHAT_SESSIONS"
# class_name = "ChatSession"
# script_name = "pravado-chat-worker"

# =====================================================
# OBSERVABILITY
# =====================================================

[observability]
enabled = true

# Logpush (send logs to external service)
# [observability.logpush]
# enabled = true
# destination = "https://your-log-collector.com/ingest"

# =====================================================
# CUSTOM DOMAINS (Configure in Cloudflare Dashboard)
# =====================================================

# Production: app.pravado.com
# Preview: preview.pravado.com
# Development: dev.pravado.com

# =====================================================
# DEPLOYMENT TRIGGERS
# =====================================================

# Production deploys on:
# - Push to main branch
# - Git tag: v*.*.*

# Preview deploys on:
# - Pull requests
# - Push to develop branch

# =====================================================
# PERFORMANCE
# =====================================================

[performance]
# Enable compression
compression = "gzip,br"

# Minification
minify = true

# Asset optimization
image_optimization = true

# =====================================================
# NOTES
# =====================================================

# 1. Set REACT_APP_SUPABASE_ANON_KEY in Cloudflare Pages dashboard
#    (Secret environment variable)
#
# 2. Configure custom domains in Cloudflare Pages dashboard:
#    - app.pravado.com → Production
#    - preview.pravado.com → Preview
#
# 3. Enable automatic deployments from GitHub:
#    - Main branch → Production
#    - Pull requests → Preview
#
# 4. Set up deployment notifications:
#    - Slack webhook
#    - Email alerts
#
# 5. Configure access policies:
#    - Enable Cloudflare Access for preview deployments
#    - Restrict access to team members
#
# 6. Monitor performance:
#    - Cloudflare Web Analytics
#    - Real User Monitoring (RUM)
#
# 7. Review security headers periodically
#
# 8. Update NODE_VERSION and PNPM_VERSION as needed
